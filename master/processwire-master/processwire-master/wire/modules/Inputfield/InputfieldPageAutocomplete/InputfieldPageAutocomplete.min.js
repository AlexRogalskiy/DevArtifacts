var InputfieldPageAutocomplete={init:function(p,e,h,o,j){var f=$("#"+p);var k=$("#"+p+"_items");var c=$("#"+p+"_input");var a=c.parent().find(".InputfieldPageAutocompleteStatus");var i=c.parent().find(".InputfieldPageAutocompleteNote");var g=0;var l=0;var q=c.attr("data-disablechars");var b=c.hasClass("no_list");function m(u,v){var x=u.height();if(x){var w=u.parent().height();var t=((w-x)/2);u.css("top",t+"px");if(v=="left"){u.css("left",(t/2)+"px")}else{if(v=="right"){u.css("right",(t/4)+"px")}}}else{}}function n(u){if(!q||!q.length){return false}var t=false;for(var v=0;v<q.length;v++){if(u.indexOf(q[v])>-1){t=true;break}}return t}m(a,"left");if(b){c.attr("data-selectedLabel",c.val());var d=c.siblings(".InputfieldPageAutocompleteRemove");m(d,"right");d.click(function(){f.val("").change();c.val("").attr("placeholder","").attr("data-selectedLabel","").change().focus();c.trigger("keydown")});c.change(function(){if($(this).val().length==0){d.hide()}else{d.show()}});c.focus(function(){var t=f.val();if(!t.length){return}if(n(t)){return}if($(this).hasClass("added_item")){return}$(this).attr("placeholder",$(this).attr("data-selectedLabel"));$(this).val("")}).blur(function(){setTimeout(function(){},200)})}a.click(function(){c.focus()});a.attr("data-class",a.attr("class"));function s(){var t=$("#_"+p.replace("Inputfield_","")+"_add_items").size()>0;return t}c.autocomplete({minLength:2,source:function(v,t){var u=v.term;if(n(u)){t([]);return}a.attr("class","fa fa-fw fa-spin fa-spinner");if(c.hasClass("and_words")&&u.indexOf(" ")>0){u=u.replace(/\s+/,",")}u=encodeURIComponent(u);var w=e+"&"+o+j+u;$.getJSON(w,function(x){a.attr("class",a.attr("data-class"));l=x.total;if(x.total>0){a.attr("class","fa fa-fw fa-angle-double-down")}else{if(s()){a.attr("class","fa fa-fw fa-plus-circle");i.show()}else{a.attr("class","fa fa-fw fa-frown-o")}}t($.map(x.matches,function(y){return{label:y[h],value:y[h],page_id:y.id}}))})},select:function(t,u){if(!u.item){return}var v=$(this);if(v.hasClass("no_list")){v.val(u.item.label).change();v.attr("data-selectedLabel",u.item.label);v.closest(".InputfieldPageAutocomplete").find(".InputfieldPageAutocompleteData").val(u.item.page_id).change();v.blur();return false}else{InputfieldPageAutocomplete.pageSelected(k,u.item);v.val("").focus();return false}}}).blur(function(){var t=$(this);a.attr("class",a.attr("data-class"));i.hide();if(t.hasClass("no_list")){if(f.val().length||t.val().length){if(t.hasClass("allow_any")||t.hasClass("added_item")){}else{t.val(t.attr("data-selectedLabel")).attr("placeholder","")}}else{t.val("").attr("placeholder","").attr("data-selectedLabel","")}}if(t.hasClass("focus-after-blur")){t.removeClass("focus-after-blur");setTimeout(function(){t.focus()},250)}}).keyup(function(){a.attr("class",a.attr("data-class"))}).keydown(function(u){if(u.keyCode==13){u.preventDefault();if(s()){if($.trim(c.val()).length<1){c.blur();return false}g++;var v={page_id:(-1*g),label:c.val()};if(b){f.val(v.page_id);$("#_"+p.replace("Inputfield_","")+"_add_items").val(v.label);c.addClass("added_item").blur();var t=i.siblings(".InputfieldPageAutocompleteNoteAdd");if(!t.length){var t=$("<div class='notes InputfieldPageAutocompleteNote InputfieldPageAutocompleteNoteAdd'></div>");i.after(t)}t.text(i.attr("data-adding")+" "+v.label);t.show()}else{InputfieldPageAutocomplete.pageSelected(k,v);c.val("").blur().focus()}i.hide()}else{$(this).addClass("focus-after-blur").blur()}return false}if(g&&b){var t=i.siblings(".InputfieldPageAutocompleteNoteAdd");var w=$("#_"+p.replace("Inputfield_","")+"_add_items");if(t.length&&w.val()!=$(this).val()){t.remove();f.val("");w.val("");$("#_"+p.replace("Inputfield_","")+"_add_items").val("");g--}}});var r=function(t){t.sortable({axis:"y",update:function(v,u){InputfieldPageAutocomplete.rebuildInput($(this))},start:function(v,u){u.item.addClass("ui-state-highlight")},stop:function(v,u){u.item.removeClass("ui-state-highlight")}});t.addClass("InputfieldPageAutocompleteSortable")};$("#"+k.attr("id")).on("mouseover",">li",function(){$(this).removeClass("ui-state-default").addClass("ui-state-hover");r(k)}).on("mouseout",">li",function(){$(this).removeClass("ui-state-hover").addClass("ui-state-default")})},initFromInputfield:function(a){var b=a.find(".InputfieldPageAutocompleteData");if(!b.length){return}if(b.hasClass("InputfieldPageAutocompleteInit")){return}InputfieldPageAutocomplete.init(b.attr("id"),b.attr("data-url"),b.attr("data-label"),b.attr("data-search"),b.attr("data-operator"));b.addClass("InputfieldPageAutocompleteInit")},pageSelected:function(a,d){var c=false;a.children("li:not(.itemTemplate)").each(function(){var f=parseInt($(this).children(".itemValue").text());if(f==d.page_id){c=$(this)}});var b=$("#"+a.attr("data-id")+"_input");b.blur();if(c){c.effect("highlight");return}var e=a.children(".itemTemplate").clone();e.removeClass("itemTemplate");e.children(".itemValue").text(d.page_id);e.children(".itemLabel").text(d.label);a.append(e);InputfieldPageAutocomplete.rebuildInput(a)},rebuildInput:function(d){var b=d.attr("data-id");var a=d.attr("data-name");var f=$("#"+b);var h="";var c="";var g=parseInt(f.attr("data-max"));var i=d.children(":not(.itemTemplate)");if(g>0&&i.size()>g){while(i.size()>g){i=i.slice(1)}d.children(":not(.itemTemplate)").replaceWith(i)}i.each(function(){var j=parseInt($(this).children(".itemValue").text());if(j>0){h+=","+j}else{if(j<0){h+=","+j;c+=$(this).children(".itemLabel").text()+"\n"}}});f.val(h);var e=$("#_"+a+"_add_items");if(e.size()>0){e.val(c)}}};$(document).ready(function(){$(".InputfieldPageAutocomplete").each(function(){InputfieldPageAutocomplete.initFromInputfield($(this))});$(document).on("reloaded",".InputfieldPageAutocomplete, .InputfieldPage",function(){InputfieldPageAutocomplete.initFromInputfield($(this))});$(document).on("click",".InputfieldPageAutocomplete ol a.itemRemove",function(){var c=$(this).parent();var a=c.parent();var b=c.children(".itemValue").text();c.remove();InputfieldPageAutocomplete.rebuildInput(a);return false})});